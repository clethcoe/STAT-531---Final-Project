---
title: "Final Project"
author: "Owen Bachhuber, Melanie Mitton, Magdalene Lo, Corban Lethcoe"
format: 
  html:
    self-contained: true
    code-tools: true
    toc: true
    theme: journal
editor: source
execute: 
  error: true
  echo: true
  message: false
  warning: false
code-fold: true
bibliography: references.bib
---

## Introduction

### Motivation 

As reported by the [New York Times](https://www.nytimes.com/2023/11/06/health/tuberculosis-tb-treatment-vaccine-diagnosis.html), tuberculosis (TB) has reclaimed the title of the world's leading infectious disease killer as of November 2023, after being briefly removed from its long reign by Covid-19. The World Health Organization reports that nearly 40 percent of people who are living with TB are untreated and undiagnosed. Deaths from tuberculosis remain pronounced, with 1.36 million people dying from tuberculosis in 2022.

This project aims to better contextualize the relationship between a government spending and tuberculosis on a country-by-country basis. We hypothesize that the countries that spend more on healthcare per person also see fewer deaths from tuberculosis.

### Source Data

Two data sets were chosen for this analysis: 1) the estimated numbers of deaths caused by TB (all forms) among 100,000 residents during the given year from 2000 - 2015 sorted by country, and 2) the average health expenditures per person paid by government entities from 1995 - 2010 expressed in US dollars using the average exchange rate.

The data sets were joined by country and only complete observations from 2000 - 2010 were included. The TB deaths data included 216 countries while the government healthcare spending data included 192 countries. Our combined dataset included 216 countries WHICH DOESN'T MAKE SENSE.

```{r}
#| message: false


library(tidyverse)
library(here)
library(ggplot2)
library(gridExtra)
library(gganimate)
library(gifski)

tb_deaths_long <- read_csv(here("all_forms_of_tb_deaths_per_100000_estimated.csv"))
gov_health_spending_long <- read_csv(here("government_health_spending_per_person_us.csv"))

# Count the number of countries in the source data
tb_deaths_long <- tb_deaths_long |>
  mutate(country = as.factor(country))
         nlevels(tb_deaths_long$country)

gov_health_spending_long <- gov_health_spending_long |>
  mutate(country = as.factor(country))
         nlevels(gov_health_spending_long$country)
         
# Pivot the Tuberculosis Deaths Data
tb_deaths_long <- tb_deaths_long |> 
  pivot_longer(cols = -country, names_to = "year", values_to = "deaths_per_100k", names_prefix = "X") |> 
  mutate(year = as.integer(year)) |>
  drop_na()

# Pivot the Government Health Spending Data
gov_health_spending_long <- gov_health_spending_long |> 
  pivot_longer(cols = -country, names_to = "year", values_to = "gov_health_spending_usd", names_prefix = "X") |> 
  mutate(year = as.integer(year)) |> 
  drop_na()

# Join the cleaned, long-format datasets
combined_dataset_long_cleaned <- inner_join(tb_deaths_long, gov_health_spending_long, by = c("country", "year"))

# Remove any remaining rows with NAs
combined_dataset_long_cleaned <- drop_na(combined_dataset_long_cleaned)

# Write the cleaned, combined dataset to a CSV file
write_csv(combined_dataset_long_cleaned, here("combined_dataset_long_cleaned.csv"))

# Count the number of countries in the final dataset
nlevels(combined_dataset_long_cleaned$country)

```

## Data Visualization

To examine how the relationship between our two variables of interest changed over time, we created an animated plot that shows deaths per 100k vs government spending per person in USD for every country in every year of the study (2000 - 2010).

```{r}
plot <- combined_dataset_long_cleaned |>
  ggplot(aes(
    x = gov_health_spending_usd, 
    y = deaths_per_100k
  )) + 
  geom_point() +
  labs(title = "Deaths Per 100k vs Gov Spending - Year: {frame_time}",
       y = "",
       x = "Government spending per person, USD") +
  transition_time(year) + 
  ease_aes('linear') + 
  theme(aspect.ratio = 1)+
  theme_bw()

# Create the animation object
anim <- animate(plot,nframes = 10 , duration = 20, renderer=gifski_renderer())

# Save the animation
anim_save("Animation_trials/Generated_animations/animation.gif",animation = anim)
anim
```

Over time, the amount of government spending per person increased on average. The relationship between deaths per 100k and government spending displays an exponential decay overtime, suggesting that as government spending increases, the number of deaths per 100k decreases. To confirm this inference, we created density plots of deaths per 100k and government spending per person to show how the proportional distribution changes overtime.

```{r}

## Density plot of deaths per 100k
plot_2 <- combined_dataset_long_cleaned |>
  ggplot(aes(x = deaths_per_100k)) +
  geom_density(fill = "skyblue", color = "black") +
  labs(title = "Density Plot of Deaths Per 100k - Year: {frame_time}") +
  transition_time(year) + 
  ease_aes('linear') + 
  theme(aspect.ratio = 1)

anim_2 <- animate(plot_2,nframes = 10 , duration = 20, renderer=gifski_renderer())

# Density plot of gov spending.
plot_3 <- combined_dataset_long_cleaned |>
  ggplot(aes(x = gov_health_spending_usd)) +
  geom_density(fill = "skyblue", color = "black") +
  labs(title = "Density Plot of Gov Spending Per Person in USD - Year: {frame_time}") +
  transition_time(year) + 
  ease_aes('linear') + 
  theme(aspect.ratio = 1)

anim_3 <- animate(plot_3,nframes = 10 , duration = 20, renderer=gifski_renderer())
anim_2

```

```{r}
anim_3
```

From these plots, it becomes clearer to see that as government spending increased overtime, the number of deaths per 100k decreased.

## Linear Regression

To further explore the relationship between government spending and deaths caused by TB, we took the average government spending and average deaths per 100k for all recorded years for each country and fit a linear regression to the dataset.

### Visualization

```{r}
combined_dataset_long_cleaned |> 
  group_by(country) |> 
  summarise(mean_deaths = mean(deaths_per_100k), 
            mean_spending = mean(gov_health_spending_usd)) |>
  ggplot(aes(x = mean_deaths, y = mean_spending)) +
  geom_point() + 
  geom_smooth(method = "lm") + 
  xlab("Mean Government Spending in USD") + 
  ylab("") + 
  ggtitle("Mean Deaths Per 100 k")
```

#### Creating the Regression Model

```{r}
combined_dataset_long_av <- combined_dataset_long_cleaned |> 
  group_by(country) |> 
  summarise(av_deaths_per_100k = mean(deaths_per_100k),
            av_gov_health_spending_usd = mean(gov_health_spending_usd)) |> 
  ungroup()

combined_dataset_lm <- lm(av_deaths_per_100k ~ av_gov_health_spending_usd , 
                          data = combined_dataset_long_av)

broom::tidy(combined_dataset_lm)
```

#### Linear Regression Equation

av_deaths_per_100k = 44.52 - 0.017(av_gov_health_spending_usd)

#### Interpretation

There is a negative correlation between Deaths per 100K and Government Spending. Our model suggests that for every \$1000(USD) spent by a government on healthcare, 17 people per 100,000 can be saved from dying of TB.

```{r}
summary(combined_dataset_lm)
```

With an R-squared value of about 0.051, our suspicions from the regression visualization are confirmed and our linear model is not a great fit for the data. Though our model is a poor predictor of the data trends, we can tell from our P-values (both \< 2e-16) that there is a very strong correlation between these two variables.

## Sources

Nolen, S. (2023, November 6) Ending TB Is Within Reach --- So Why Are Millions Still Dying? *The New York Times*. <https://www.nytimes.com/2023/11/06/health/tuberculosis-tb-treatment-vaccine-diagnosis.html>

TB deaths per 100,000, estimated, all forms of TB: World Health Organization through [gapminder.org](https://www.gapminder.org/data/)

Govt. health spending per person (US\$): World Health Organization through [gapminder.org](https://www.gapminder.org/data/)
